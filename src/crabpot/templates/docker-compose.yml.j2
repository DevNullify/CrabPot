version: "3.8"

services:
  crabpot:
    container_name: crabpot
    build:
      context: .
      dockerfile: Dockerfile.crabpot
    restart: unless-stopped

    # ── Network ──────────────────────────────────────────
    ports:
      - "127.0.0.1:18789:18789"
    networks:
      - crabpot_net

    # ── Filesystem hardening ─────────────────────────────
    read_only: true
    tmpfs:
      - /tmp:size=256m,noexec,nosuid
      - /run:size=64m,noexec,nosuid

    # ── User ─────────────────────────────────────────────
    user: "1000:1000"

    # ── Security options ─────────────────────────────────
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
      - seccomp={{ seccomp_path }}

    # ── Resource limits ──────────────────────────────────
    deploy:
      resources:
        limits:
          cpus: "{{ cpu_limit }}"
          memory: {{ memory_limit }}
        reservations:
          memory: 256m
    pids_limit: {{ pids_limit }}

    # ── Egress proxy (routes all traffic through CrabPot policy engine) ──
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - HTTP_PROXY=http://host.docker.internal:{{ egress_proxy_port }}
      - HTTPS_PROXY=http://host.docker.internal:{{ egress_proxy_port }}
      - NO_PROXY=localhost,127.0.0.1

    # ── Environment ──────────────────────────────────────
    env_file:
      - .env

    # ── Volumes ──────────────────────────────────────────
    volumes:
      - crabpot_data:/app/data

    # ── Healthcheck ──────────────────────────────────────
    healthcheck:
      test: ["CMD-SHELL", "node -e 'require(\"http\").get(\"http://localhost:18789/health\", r => process.exit(r.statusCode === 200 ? 0 : 1)).on(\"error\", () => process.exit(1))'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

    # ── Logging ──────────────────────────────────────────
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"

networks:
  crabpot_net:
    driver: bridge
    internal: false
    driver_opts:
      com.docker.network.bridge.enable_icc: "false"

volumes:
  crabpot_data:
