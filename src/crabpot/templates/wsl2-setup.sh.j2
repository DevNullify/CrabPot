#!/bin/bash
# CrabPot WSL2 Security Setup Script
# Generated by CrabPot — do not edit manually.

set -euo pipefail

echo "CrabPot WSL2 security setup..."

# ── Create unprivileged user ──────────────────────────────
{% if drop_all_caps %}
if ! id -u crabpot &>/dev/null; then
    useradd -m -s /bin/bash -u 1000 crabpot
    echo "Created unprivileged user 'crabpot'"
fi
# Remove sudo access
deluser crabpot sudo 2>/dev/null || true
{% endif %}

# ── Read-only rootfs ─────────────────────────────────────
{% if read_only_rootfs %}
# Create writable overlay directories
mkdir -p /tmp /run /app/data
chown 1000:1000 /app/data
# Note: actual remount happens at boot via fstab
echo "tmpfs /tmp tmpfs size=256m,noexec,nosuid 0 0" >> /etc/fstab
echo "tmpfs /run tmpfs size=64m,noexec,nosuid 0 0" >> /etc/fstab
{% endif %}

# ── Resource limits via cgroups v2 ───────────────────────
{% if resource_limits %}
mkdir -p /sys/fs/cgroup/crabpot
echo "{{ cpu_limit }}00000" > /sys/fs/cgroup/crabpot/cpu.max 2>/dev/null || true
echo "{{ memory_limit }}" > /sys/fs/cgroup/crabpot/memory.max 2>/dev/null || true
{% if pid_limit %}
echo "{{ pids_limit }}" > /sys/fs/cgroup/crabpot/pids.max 2>/dev/null || true
{% endif %}
{% endif %}

# ── Egress firewall rules ────────────────────────────────
{% if egress_proxy %}
# Redirect outbound HTTP/HTTPS to host proxy
iptables -t nat -A OUTPUT -p tcp --dport 80 -j REDIRECT --to-port 9877 2>/dev/null || true
iptables -t nat -A OUTPUT -p tcp --dport 443 -j REDIRECT --to-port 9877 2>/dev/null || true
{% endif %}

# ── Hardened image (binary stripping) ────────────────────
{% if hardened_image %}
apt-get remove --purge -y curl wget netcat-openbsd ncat ssh openssh-client 2>/dev/null || true
rm -f /usr/bin/curl /usr/bin/wget /usr/bin/nc /usr/bin/ssh
find / -perm /4000 -type f -exec chmod u-s {} + 2>/dev/null || true
find / -perm /2000 -type f -exec chmod g-s {} + 2>/dev/null || true
{% endif %}

echo "CrabPot WSL2 security setup complete."
